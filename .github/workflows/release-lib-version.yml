name: Release lib-version

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-24.04

    # Use GITHUB_TOKEN for publishing to GitHub Packages
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Configure Maven for GitHub Packages
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${env.GITHUB_ACTOR}</username>
                <password>${env.GH_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Read current POM version
        id: pomver
        run: |
          ver=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "pom_version=$ver" >> "$GITHUB_OUTPUT"

      - name: Check if release version (not SNAPSHOT)
        id: check
        run: |
          ver="${{ steps.pomver.outputs.pom_version }}"

          # Only release if version is stable (no -SNAPSHOT)
          if echo "$ver" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "is_release=true" >> "$GITHUB_OUTPUT"
            echo "release_version=$ver" >> "$GITHUB_OUTPUT"
            echo "Release version detected: $ver"
          else
            echo "is_release=false" >> "$GITHUB_OUTPUT"
            echo "Skipping - not a release version: $ver"
          fi

      - name: Build & deploy release to GitHub Packages
        if: steps.check.outputs.is_release == 'true'
        run: >
          mvn -B clean deploy -DskipTests
          -DaltDeploymentRepository=github::https://maven.pkg.github.com/doda2025-team17/lib-version

      - name: Commit release version
        if: steps.check.outputs.is_release == 'true'
        run: |
          # Only commit if there are changes (shouldn't be any, but just in case)
          if ! git diff --quiet; then
            git commit -am "Release ${{ steps.check.outputs.release_version }}"
          fi

      - name: Create and push tag (before SNAPSHOT bump)
        if: steps.check.outputs.is_release == 'true'
        run: |
          ver="${{ steps.check.outputs.release_version }}"
          tag="v${ver}"

          # Check if tag already exists
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists locally"
          elif git ls-remote --tags origin | grep -q "refs/tags/$tag$"; then
            echo "Tag $tag already exists on remote"
          else
            # Create annotated tag at current HEAD
            git tag -a "$tag" -m "Release version $ver"
            echo "Created tag $tag at commit $(git rev-parse HEAD)"
            
            # Push tag immediately (before SNAPSHOT bump)
            git push origin "$tag"
            echo "Pushed tag $tag"
          fi

      - name: Calculate next SNAPSHOT version
        if: steps.check.outputs.is_release == 'true'
        id: nextver
        run: |
          ver="${{ steps.check.outputs.release_version }}"
          IFS='.' read -r major minor patch <<< "$ver"
          patch=$((patch+1))
          next="${major}.${minor}.${patch}-SNAPSHOT"
          echo "next=$next" >> "$GITHUB_OUTPUT"
          echo "Next SNAPSHOT version: $next"

      - name: Bump to next SNAPSHOT version
        if: steps.check.outputs.is_release == 'true'
        run: |
          mvn -B versions:set \
            -DnewVersion=${{ steps.nextver.outputs.next }} \
            -DgenerateBackupPoms=false

      - name: Commit SNAPSHOT bump
        if: steps.check.outputs.is_release == 'true'
        run: |
          git add pom.xml
          git commit -m "chore: bump version to ${{ steps.nextver.outputs.next }} [skip ci]"
          echo "Committed SNAPSHOT bump"

      - name: Push SNAPSHOT commit
        if: steps.check.outputs.is_release == 'true'
        run: |
          git push origin HEAD
          echo "Pushed SNAPSHOT commit"

      - name: Verify tag points to correct commit
        if: steps.check.outputs.is_release == 'true'
        run: |
          ver="${{ steps.check.outputs.release_version }}"
          tag="v${ver}"

          # Get version from tagged commit
          git checkout "$tag"
          tagged_ver=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          git checkout -

          echo "Tag $tag points to version: $tagged_ver"

          if [ "$tagged_ver" = "$ver" ]; then
            echo "Tag metadata is consistent!"
          else
            echo "ERROR: Tag $tag points to version $tagged_ver, expected $ver"
            exit 1
          fi
