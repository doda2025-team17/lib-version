name: Release lib-version

# Only runs when a Git tag matching vX.Y.Z is pushed
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  release:
    runs-on: ubuntu-24.04

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # need full history & tags

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Creates a xml file to allow Maven to authenticate and upload the library to GitHub Packages
      - name: Configure Maven for GitHub Packages
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${env.GITHUB_ACTOR}</username>
                <password>${env.GH_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Extract release version from tag
        id: tagver
        run: |
          # refs/tags/v1.2.3 -> 1.2.3
          ref="${GITHUB_REF##*/}"
          ver="${ref#v}"
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Read current pom version
        id: pomver
        run: |
          base=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "pom_version=$base" >> "$GITHUB_OUTPUT"

      - name: Verify pom version matches tag (X.Y.Z-SNAPSHOT)
        run: |
          tag_ver="${{ steps.tagver.outputs.version }}"
          pom_ver="${{ steps.pomver.outputs.pom_version }}"
          expected="${tag_ver}-SNAPSHOT"
          echo "Tag version:      $tag_ver"
          echo "POM version:      $pom_ver"
          echo "Expected in POM:  $expected"
          if [ "$pom_ver" != "$expected" ]; then
            echo "ERROR: POM version must be $expected before releasing."
            exit 1
          fi

      - name: Set release version (remove -SNAPSHOT)
        run: |
          mvn -B versions:set \
            -DnewVersion=${{ steps.tagver.outputs.version }} \
            -DgenerateBackupPoms=false

      - name: Build & deploy release to GitHub Packages
        run: mvn -B clean deploy -DskipTests
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Commit released version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -am "Release ${{ steps.tagver.outputs.version }}" || echo "No changes to commit"

      - name: Move tag to this commit
        run: |
          ver="${{ steps.tagver.outputs.version }}"
          git tag -d "v${ver}" || true
          git tag "v${ver}"

      - name: Calculate next SNAPSHOT version
        id: nextver
        run: |
          ver="${{ steps.tagver.outputs.version }}"   # e.g. 1.0.0
          IFS='.' read -r major minor patch <<< "$ver"
          patch=$((patch+1))
          next="${major}.${minor}.${patch}-SNAPSHOT"
          echo "next=$next" >> "$GITHUB_OUTPUT"

      - name: Set next SNAPSHOT in pom.xml
        run: |
          mvn -B versions:set \
            -DnewVersion=${{ steps.nextver.outputs.next }} \
            -DgenerateBackupPoms=false

      - name: Commit next SNAPSHOT bump
        run: |
          git commit -am "Bump version to ${{ steps.nextver.outputs.next }}" || echo "No changes to commit"

      - name: Push commits and tag
        run: |
          git push origin HEAD
          git push --force origin "v${{ steps.tagver.outputs.version }}"
