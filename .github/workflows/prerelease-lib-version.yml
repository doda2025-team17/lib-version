name: Pre-release lib-version (branches)

on:
  push:
    branches-ignore:
      - main

jobs:
  prerelease:
    runs-on: ubuntu-24.04

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Configure Maven for GitHub Packages
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${env.GITHUB_ACTOR}</username>
                <password>${env.GH_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Read base version from pom.xml
        id: basever
        run: |
          base=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          base=${base%-SNAPSHOT}   # drop -SNAPSHOT if present
          echo "base=$base" >> "$GITHUB_OUTPUT"

      - name: Build pre-release version string
        id: prerelease
        run: |
          base="${{ steps.basever.outputs.base }}"   # e.g. 1.0.1
          branch="${GITHUB_REF_NAME}"                # e.g. feature/lib-x
          branch=${branch//\//-}                     # replaces / with -
          ts=$(date +'%Y%m%d-%H%M%S')                # strictly increasing timestamp
          version="${base}-${branch}-${ts}"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Set pre-release version in pom.xml
        run: |
          mvn -B versions:set \
            -DnewVersion=${{ steps.prerelease.outputs.version }} \
            -DgenerateBackupPoms=false

      - name: Build & deploy pre-release
        run: >
          mvn -B clean deploy -DskipTests
          -DaltDeploymentRepository=github::default::https://maven.pkg.github.com/doda2025-team17/lib-version
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}


      - name: Restore SNAPSHOT pom.xml
        run: |
          git restore pom.xml || true
